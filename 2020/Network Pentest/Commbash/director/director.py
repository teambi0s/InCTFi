import socket
from os import environ
from time import sleep
from random import choice

TCP_IP=environ["ACTOR_IP"]
TCP_PORT=8989
commands = ["id", "whoami", "uname", "ls /var/log/" ]

def getcomm(commands):
    command = choice(commands)
    data = "----BEGINREQUEST----" + command.encode("base64").replace("\n",'') + "----ENDREQUEST----\n"
    return data

FIRST_SECRET='763'
FIRST_TIME = True
while True:
    if FIRST_TIME:
        sleep(1)
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((TCP_IP, TCP_PORT))
        s.send("Secret: "+FIRST_SECRET + "\n")
        sleep(1)
        try:
            s.send(getcomm(commands))
            data = s.recv(1024)
            ind = data.find("Next Secret: ")
            NEXT_SECRET = data[ind+13::][:3]
            s.close()
            FIRST_TIME = False
        except Exception as e:
            print(e)

    else:
        sleep(1)
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((TCP_IP, TCP_PORT))
        s.send("Secret: " + NEXT_SECRET + "\n")
        sleep(1)
        try:
            s.send(getcomm(commands))
            data = s.recv(1024)
            if("Wrong Secret :(" in data):
                FIRST_TIME=True
            ind = data.find("Next Secret: ")
            NEXT_SECRET = data[ind+13::][:3]
            s.close()
        except Exception as e:
            print(e)
