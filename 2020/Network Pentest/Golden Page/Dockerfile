FROM ubuntu:18.04 as build

LABEL MAINTAINER Jaswanth Bommidi <mail@evilsyn.com>

RUN apt update; apt -y --autoremove full-upgrade
ARG DEBIAN_FRONTEND=noninteractive
RUN apt install vsftpd ftp apache2 php php-mysqli mysql-server openssh-server cron -y

RUN apt-get autoremove
RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*



RUN mkdir -p /var/ftp/pub
RUN chmod 777 /var/ftp/pub
COPY vsftpd.conf /etc/vsftpd.conf
COPY start.sh /root/start.sh

RUN bash -c "useradd -m alanjarvis -s /bin/bash"
RUN bash -c "echo alanjarvis:BMsKeSgfDjp3nSwqEAWSCU | chpasswd"

COPY key.pub /home/alanjarvis/.ssh/authorized_keys
COPY key  /home/alanjarvis/.ssh/id_rsa
RUN sed -i s/"^#PasswordAuthentication yes"/"PasswordAuthentication no"/g /etc/ssh/sshd_config

RUN chown -R alanjarvis:alanjarvis /home/alanjarvis/.ssh/

COPY index.php /var/www/html/index.php
RUN rm /var/www/html/index.html


RUN chmod -R 777 /var/www/html

COPY flag.txt /root/flag.txt

COPY blindboi.sql /var/www/html/blindboi.sql

RUN mkdir -p /usr/share/misc/scripts/
COPY cron.sh /usr/share/misc/scripts/cron.sh
RUN chmod 700 /usr/share/misc/scripts/cron.sh

RUN mkdir -p /usr/share/misc/remove_script/
RUN chown -R alanjarvis:alanjarvis /usr/share/misc/remove_script/
COPY remove.sh /usr/share/misc/remove_script/remove.sh
RUN chmod 700 /usr/share/misc/remove_script/remove.sh


RUN mkdir -p /var/backups/uploads

RUN echo "*/2 * * * * root /usr/share/misc/scripts/cron.sh >> /var/log/cron.log 2>&1" > /etc/cron.d/backup
RUN chmod 700 /etc/cron.d/backup
RUN touch /var/log/cron.log
RUN chmod +r /var/log/cron.log
RUN chmod -R 777 /var/backups/uploads

EXPOSE 80 3306

ENTRYPOINT [ "bash", "/root/start.sh"]